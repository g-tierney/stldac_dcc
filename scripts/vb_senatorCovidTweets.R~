library(tidyverse)
library(quanteda)
library(stopwords)

source("scripts/setup.R")
source("scripts/helper_functions.R")
source("scripts/vb_stldac_functions.R")
source("scripts/vb_implementation.R")

print(str_c("Time: ",Sys.time(),", cores: ",parallel::detectCores()))
parallel::mclapply(1:5,function(i) print(i),mc.cores=parallel::detectCores())


senTweets116 <- rtweet::read_twitter_csv("senatorTweet_data/senators116_3200RecentTweets_2020-06-01.csv") %>% 
  mutate(date = as.Date(created_at))
senDemos <- openxlsx::read.xlsx("senatorTweet_data/116_Senator_Twitter_Handles.xlsx") %>% 
  filter(!str_detect(senator_name,"Isakson"))


senTweets116_2020 <- senTweets116 %>% 
  filter(date >= as.Date("2020-01-01") & date <= as.Date("2020-05-31"),!str_detect(screen_name,"isakson")) 
  
senTweets116_2020$text_clean <- 
  str_replace_all(senTweets116_2020$text,"https?://([a-z\\.]*)/([:alnum:]*)","hyperlink") #remove URLs


senTweets116_2020.dfm <- dfm(senTweets116_2020$text_clean,tolower = T,remove = c(stopwords(source = "smart"),"hyperlink","amp"),remove_punct = T)
docvars(senTweets116_2020.dfm) <- senTweets116_2020

senTweets116_2020.dfm %>% colSums() %>% sort(decreasing = T) %>% {.[1:10]}

senTweets116_2020.dfm_trimmed <- senTweets116_2020.dfm %>% dfm_trim(min_docfreq = 0.001,docfreq_type = "prop") %>% 
  {dfm_subset(.,subset = ntoken(.)>1)} %>% 
  dfm_trim(min_docfreq = 1,docfreq_type = "count")

senTweets116_2020.dfm_trimmed@docvars %>% group_by(screen_name) %>% summarise(n=n()) %>% arrange(n)


senators <- senTweets116_2020.dfm_trimmed@docvars$screen_name

print(senators[1:3])
print(senators %>% unique %>% length)

senator_vb <- stldac_vb(users=senators,dw=convert(senTweets116_2020.dfm_trimmed,to = "matrix"),nT = 30,nC = 4,tol = .01,seed = 1,maxiter = 4)
saveRDS(senator_vb,file = "senatorTweet_data/vb_test_4C_30T.rds")